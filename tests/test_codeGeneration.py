import pytest
import time
import os
import hashlib
from pathlib import Path
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from helperFunctions import (
    createNewModel,
    deleteAllModels,
    createCodeGenerationModel,
)
from env import BASE_URL, USERNAME, PASSWORD

@pytest.fixture
def driver():
    #selenium_url = os.getenv('SELENIUM_URL')
    options = webdriver.ChromeOptions()
    #options.add_argument("--headless")
    options.add_argument("--no-sandbox")
    options.add_argument('--ignore-ssl-errors=yes')
    options.add_argument('--ignore-certificate-errors')
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--allow-insecure-localhost")
    options.add_argument("--allow-running-insecure-content")
    options.add_argument("--disable-features=InsecureDownloadWarnings")
    options.add_argument("--unsafely-treat-insecure-origin-as-secure=http://frontend-integration:3000")
    options.add_experimental_option("prefs", {
        "download.default_directory": "/home/seluser/Downloads",
        "download.prompt_for_download": False,
        "download.directory_upgrade": True,
        "safebrowsing.enabled": False, 
        "safebrowsing.disable_download_protection": True 
    })

    retryDriver = 0
    while retryDriver < 3:
        try:
            driver = webdriver.Remote(
                command_executor='http://selenium:4444/wd/hub',
                options = options
            )
            break
        except:
            retryDriver += 1
            if retryDriver < 3:
                time.sleep(30) 
            else:
                raise

    yield driver

    # Delete models
    deleteAllModels()

    driver.quit()

def test_switchToCodeGenerationTab(driver):
    retryModelCreation = 0
    while retryModelCreation < 3:
        try: 
            createNewModel(driver)
            break
        except:
            deleteAllModels()
            retryModelCreation += 1
            if retryModelCreation < 3:
                time.sleep(10)
            else:
                raise

    driver.maximize_window()
    wait = WebDriverWait(driver, 10)
    wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, '[data-rr-ui-event-key="aceEditor"]'))).click()

    assert wait.until(EC.visibility_of_element_located((By.CLASS_NAME, "ace_content"))) is not None, "Code Generation not found"

def test_checkCodeGeneration(driver):
    createCodeGenerationModel()
    driver.maximize_window()
    wait = WebDriverWait(driver, 10)
    driver.get(BASE_URL + "/model/CodeGeneration")
    wait.until(EC.title_contains("CodeGeneration"))

    wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, '[data-rr-ui-event-key="aceEditor"]'))).click()

    ucDSLEditorExpectedhtml = '<div id="ucDSLEditor" class=" ace_editor ace_hidpi ace-pastel-on-dark ace_dark" style="width: 700px; height: 750px; font-size: 14px;"><textarea class="ace_text-input" wrap="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-haspopup="false" aria-autocomplete="both" role="textbox" readonly="" style="opacity: 0; font-size: 1px; transform: translate(0px, 0px);"></textarea><div class="ace_gutter" aria-hidden="true" style="left: 0px; width: 49px;"><div class="ace_layer ace_gutter-layer ace_folding-enabled" style="height: 1e+06px; transform: translate(0px, 0px); width: 49px;"><div class="ace_gutter-cell " style="height: 16px; top: 0px;">1<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 16px;">2<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 32px;">3<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 48px;">4<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 64px;">5<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 80px;">6<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 96px;">7<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 112px;">8<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 128px;">9<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 144px;">10<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 160px;">11<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 176px;">12<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 192px;">13<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 208px;">14<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 224px;">15<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 240px;">16<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 256px;">17<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 272px;">18<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 288px;">19<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 304px;">20<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 320px;">21<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 336px;">22<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 352px;">23<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 368px;">24<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 384px;">25<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 400px;">26<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 416px;">27<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 432px;">28<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 448px;">29<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 464px;">30<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 480px;">31<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 496px;">32<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 512px;">33<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 528px;">34<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 544px;">35<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 560px;">36<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 576px;">37<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 592px;">38<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 608px;">39<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 624px;">40<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 640px;">41<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 656px;">42<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 672px;">43<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 688px;">44<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 704px;">45<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 720px;">46<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 736px;">47<span style="display: none;"></span></div><div class="ace_gutter-cell " style="height: 16px; top: 752px;">48<span style="display: none;"></span></div></div></div><div class="ace_scroller" style="line-height: 16px; left: 48.6797px; right: 15px; bottom: 0px;"><div class="ace_content" style="transform: translate(0px, 0px); width: 714px; height: 767px;"><div class="ace_layer ace_print-margin-layer"><div class="ace_print-margin" style="left: 631px; visibility: visible;"></div></div><div class="ace_layer ace_marker-layer"></div><div class="ace_layer ace_text-layer" style="height: 1e+06px; margin: 0px 4px; transform: translate(0px, 0px);"><div class="ace_line" style="height: 16px; top: 0px;"><span class="ace_comment">(* You have made use of other models in this model. You must include the following:</span></div><div class="ace_line" style="height: 16px; top: 16px;"><span class="ace_comment"> * uc_requires BasicModel BasicModel.</span></div><div class="ace_line" style="height: 16px; top: 32px;"><span class="ace_comment"> *)</span></div><div class="ace_line" style="height: 16px; top: 48px;"></div><div class="ace_line" style="height: 16px; top: 64px;"><span class="ace_comment">(* Basic direct interface *)</span></div><div class="ace_line" style="height: 16px; top: 80px;"><span class="ace_keyword">direct</span> <span class="ace_identifier">Basic1</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 96px;"><span class="ace_indent-guide">  </span> <span class="ace_keyword">in</span> <span class="ace_identifier">pt</span><span class="ace_keyword ace_operator">@</span><span class="ace_identifier">message1</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">param1</span> : <span class="ace_identifier">type1</span><span class="ace_paren ace_rparen">)</span></div><div class="ace_line" style="height: 16px; top: 112px;"><span class="ace_indent-guide">  </span> <span class="ace_keyword">out</span> <span class="ace_identifier">message2</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">param2</span> : <span class="ace_identifier">type2</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">@</span><span class="ace_identifier">pt</span></div><div class="ace_line" style="height: 16px; top: 128px;"><span class="ace_paren ace_rparen">}</span></div><div class="ace_line" style="height: 16px; top: 144px;"></div><div class="ace_line" style="height: 16px; top: 160px;"><span class="ace_comment">(* Basic adversarial interface *)</span></div><div class="ace_line" style="height: 16px; top: 176px;"><span class="ace_keyword">adversarial</span> <span class="ace_identifier">BasicAdv1</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 192px;"><span class="ace_indent-guide">  </span> <span class="ace_keyword">in</span> <span class="ace_identifier">message3</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">param3</span> : <span class="ace_identifier">type3</span><span class="ace_paren ace_rparen">)</span></div><div class="ace_line" style="height: 16px; top: 208px;"><span class="ace_indent-guide">  </span> <span class="ace_keyword">out</span> <span class="ace_identifier">message4</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">param4</span> : <span class="ace_identifier">type4</span><span class="ace_paren ace_rparen">)</span></div><div class="ace_line" style="height: 16px; top: 224px;"><span class="ace_paren ace_rparen">}</span></div><div class="ace_line" style="height: 16px; top: 240px;"></div><div class="ace_line" style="height: 16px; top: 256px;"><span class="ace_comment">(* Basic adversarial interface *)</span></div><div class="ace_line" style="height: 16px; top: 272px;"><span class="ace_keyword">adversarial</span> <span class="ace_identifier">IFAdvInter</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 288px;"></div><div class="ace_line" style="height: 16px; top: 304px;"><span class="ace_paren ace_rparen">}</span></div><div class="ace_line" style="height: 16px; top: 320px;"></div><div class="ace_line" style="height: 16px; top: 336px;"><span class="ace_comment">(* Basic adversarial interface *)</span></div><div class="ace_line" style="height: 16px; top: 352px;"><span class="ace_keyword">adversarial</span> <span class="ace_identifier">SimAdvInter</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 368px;"></div><div class="ace_line" style="height: 16px; top: 384px;"><span class="ace_paren ace_rparen">}</span></div><div class="ace_line" style="height: 16px; top: 400px;"></div><div class="ace_line" style="height: 16px; top: 416px;"><span class="ace_comment">(* Composite direct interface *)</span></div><div class="ace_line" style="height: 16px; top: 432px;"><span class="ace_keyword">direct</span> <span class="ace_identifier">Comp1</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 448px;"><span class="ace_indent-guide">  </span> <span class="ace_identifier">BasicInt1</span> : <span class="ace_identifier">Basic1</span></div><div class="ace_line" style="height: 16px; top: 464px;"><span class="ace_paren ace_rparen">}</span></div><div class="ace_line" style="height: 16px; top: 480px;"></div><div class="ace_line" style="height: 16px; top: 496px;"><span class="ace_comment">(* Composite adversarial interface *)</span></div><div class="ace_line" style="height: 16px; top: 512px;"><span class="ace_keyword">adversarial</span> <span class="ace_identifier">CompAdv1</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 528px;"><span class="ace_indent-guide">  </span> <span class="ace_identifier">BasicInt2</span> : <span class="ace_identifier">BasicAdv1</span></div><div class="ace_line" style="height: 16px; top: 544px;"><span class="ace_paren ace_rparen">}</span></div><div class="ace_line" style="height: 16px; top: 560px;"></div><div class="ace_line" style="height: 16px; top: 576px;"><span class="ace_comment">(* Real Functionality *)</span></div><div class="ace_line" style="height: 16px; top: 592px;"><span class="ace_keyword">functionality</span> <span class="ace_identifier">Real_Functionality</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Param1</span> : <span class="ace_identifier">BasicModel</span>.<span class="ace_identifier">CompDir1</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword">implements</span> <span class="ace_identifier">Comp1</span> <span class="ace_identifier">CompAdv1</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 608px;"></div><div class="ace_line" style="height: 16px; top: 624px;">  <span class="ace_comment">(* Subfunctionalites *)</span></div><div class="ace_line" style="height: 16px; top: 640px;">  <span class="ace_keyword">subfun</span> <span class="ace_identifier">Sub1</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">BasicModel</span>.<span class="ace_identifier">IF</span></div><div class="ace_line" style="height: 16px; top: 656px;"></div><div class="ace_line" style="height: 16px; top: 672px;">  <span class="ace_comment">(* Party *)</span></div><div class="ace_line" style="height: 16px; top: 688px;">  <span class="ace_keyword">party</span> <span class="ace_identifier">Party1</span> <span class="ace_keyword">serves</span> <span class="ace_identifier">Comp1</span>.<span class="ace_identifier">BasicInt1</span> <span class="ace_identifier">CompAdv1</span>.<span class="ace_identifier">BasicInt2</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 704px;"><span class="ace_indent-guide">  </span>  <span class="ace_keyword">initial</span> <span class="ace_support ace_function">state</span> <span class="ace_identifier">InitState</span> <span class="ace_paren ace_lparen">{</span></div><div class="ace_line" style="height: 16px; top: 720px;"><span class="ace_indent-guide">  </span><span class="ace_indent-guide">  </span>  <span class="ace_support ace_function">match</span> <span class="ace_keyword">message</span> <span class="ace_keyword">with</span> </div><div class="ace_line" style="height: 16px; top: 736px;"><span class="ace_indent-guide">  </span><span class="ace_indent-guide">  </span><span class="ace_indent-guide">  </span>  <span class="ace_keyword ace_operator">|</span> <span class="ace_identifier">pt</span><span class="ace_keyword ace_operator">@</span><span class="ace_identifier">Comp1</span>.<span class="ace_identifier">BasicInt1</span>.<span class="ace_identifier">message1</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">param1</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=&gt;</span> <span class="ace_paren ace_lparen">{</span></div></div><div class="ace_layer ace_marker-layer"></div><div class="ace_layer ace_cursor-layer ace_hidden-cursors"><div class="ace_cursor" style="display: block; transform: translate(4px, 2016px); width: 8px; height: 16px;"></div></div></div></div><div class="ace_scrollbar ace_scrollbar-v" style="width: 20px; height: 735px; bottom: 15px;"><div class="ace_scrollbar-inner" style="width: 20px; height: 2032px;">&nbsp;</div></div><div class="ace_scrollbar ace_scrollbar-h" style="height: 20px; left: 48.6797px; right: 15px; width: 636.32px;"><div class="ace_scrollbar-inner" style="height: 20px; width: 714px;">&nbsp;</div></div><div style="height: auto; width: auto; top: 0px; left: 0px; visibility: hidden; position: absolute; white-space: pre; font: inherit; overflow: hidden;"><div style="height: auto; width: auto; top: 0px; left: 0px; visibility: hidden; position: absolute; white-space: pre; font: inherit; overflow: visible;">הההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההההה</div><div style="height: auto; width: auto; top: 0px; left: 0px; visibility: hidden; position: absolute; white-space: pre; font-style: inherit; font-variant: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; overflow: visible;">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</div></div></div>'

    ucDSLEditorActualElement = driver.find_element(By.ID, "ucDSLEditor")
    ucDSLEditorActualhtml = ucDSLEditorActualElement.get_attribute("outerHTML")

    assert ucDSLEditorExpectedhtml == ucDSLEditorActualhtml, "Code Generation HTML does not match"
    